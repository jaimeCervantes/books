<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-badge/paper-badge.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="books-icons.html">
<link rel="import" href="./utils-behavior.html">
<dom-module id="books-main">
  <template>
    <style include="iron-flex iron-positioning iron-flex-alignment">
      :host {
        --app-primary-color: #4285f4;
        --app-secondary-color: black;
        display: block;
      }

      app-header {
        color: #fff;
        background-color: var(--app-primary-color);
      }
      app-header paper-icon-button {
        --paper-icon-button-ink-color: white;
      }

      .drawer-list {
        margin: 0 20px;
      }

      .drawer-list a {
        display: block;
        padding: 0 16px;
        text-decoration: none;
        color: var(--app-secondary-color);
        line-height: 40px;
      }

      .drawer-list a.iron-selected {
        color: black;
        font-weight: bold;
      }
      :host {
        --paper-badge-margin-left: -2.5rem;
      }

      #search-form {
        line-height: 1.2;
        font-size: 1rem;
      }

      #search-form .self-end {
        padding-bottom:0.8rem;
        text-transform: capitalize;
        margin-left: 0.3rem;
        padding-left: 0.3rem;
      }

      paper-badge {
        margin-top: 1.2rem; 
      }

      paper-input.search {
        --paper-input-container-input: {
          color: white;
        }

        --paper-input-container-underline-focus: {
          border-bottom: 2px solid white;
        }

        --paper-input-container-color: #eeeeee;
        --paper-input-container-focus-color: #ffffff;
      }

      paper-progress {
        display: block;
        width: 100%;
      }

      paper-progress.red {
        --paper-progress-active-color: var(--paper-pink-300);
        --paper-progress-secondary-color: var(--paper-pink-100);
      }

    </style>

    <app-location route="{{route}}"></app-location>
    <app-route
        route="{{route}}"
        pattern="/:page"
        data="{{routeData}}"
        tail="{{subroute}}"></app-route>
    <app-route route="{{subroute}}" pattern="/:category" 
      data="{{routeDataCat}}">
    </app-route>

    <iron-ajax
       auto
       id="books"
       url='[[url]]'
       handle-as="json",
       last-response="{{data}}"
       params="[[params]]"
       loading="{{loading}}"
       ></iron-ajax>

    <iron-ajax
      id="search"
      auto="[[isSearchAuto]]"
      url='[[getUrl(urlApi, "/books/search")]]'
      handle-as="json",
      params='[[search]]'
      last-response="{{data}}"
      debounce-duration="300"
      loading="{{loading}}"></iron-ajax>

    <app-drawer-layout fullbleed>
      <!-- Drawer content -->
      <app-drawer id="drawer">
        <app-toolbar>Categorias</app-toolbar>
        <iron-selector selected="{{categoryName}}" attr-for-selected="name" class="drawer-list" role="navigation">
          <a name="Todas" href="/categoria/todas">Todas</a>
          <template is="dom-repeat" items=[[categories]] as=cat index-as=index>
           <a name="[[cat._id]]" href$="/categoria/[[cat._id]]">[[cat._id]] <paper-badge label="[[cat.num]]"></paper-badge></a>          
          </template>
        </iron-selector>

      </app-drawer>

      <!-- Main content -->
      <app-header-layout has-scrolling-region>

        <app-header condenses reveals effects="waterfall">
          <app-toolbar>
            <paper-icon-button icon="books-icons:menu" drawer-toggle></paper-icon-button>
            <form id="search-form" class="flex-2 layout horizontal center-center">
              <paper-input class="search" on-keyup="getAll" value="{{search.text}}" label="Buscar libro">
                <iron-icon icon="search" prefix></iron-icon>
              </paper-input>
              <div class="self-end">en {{search.category}}</div>
            </form>
          </app-toolbar>
          <paper-progress hidden="[[!loading]]"indeterminate class="red"></paper-progress>
        </app-header>

        <iron-pages
            selected="[[page]]"
            attr-for-selected="name"
            fallback-selection="view404"
            role="main">
          <books-list name="categoria" route="[[subroute]]" data="[[data]]" loading="[[loading]]" params="{{params}}" search="{{search}}" books="[[books]]" current-page="{{currentPage}}"></books-list>
          <books-view404 name="view404"></books-view404>
        </iron-pages>
      </app-header-layout>
    </app-drawer-layout>
  </template>

  <script>
    Polymer({
      is: 'books-main',

      properties: {
        page: {
          type: String,
          reflectToAttribute: true,
          observer: '_pageChanged'
        },
        routeData: Object,
        routeDataCat: Object,
        categories: {
          type: Array
        },
        categoryName: {
          type: String,
          value: 'Todas'
        },
        data: {
          type: Object
        },
        search: {
          type: Object,
          value: {
            text: '',
            category: 'Todas'
          }
        },
        categories: {
          type: Array,
          computed: 'setCategories(data.categories)',
          notify: true
        },
        isSearchAuto: {
          type: Boolean,
          value: false
        },
        params: {
          type: Object,
          value: {}
        },
        books: {
          type: Array,
          value: function() {
            return [];
          }
        },
        currentPage: {
          type: Number,
          value: 0
        }
      },
      behaviors: [utilsBehavior],
      observers: [
        '_routePageChanged(routeData.page)',
        'searchByText(search.text)',
        'getUrlCategory(routeDataCat.category)'
      ],
      _routePageChanged: function(page) {
        this.page = page || 'categoria';

        if (!this.$.drawer.persistent) {
          this.$.drawer.close();
        }
      },

      _pageChanged: function(page) {
        var validPages = {
          categoria: 'list'
        }

        var validPage = validPages[page];

        if(!validPage) {
          validPage = 'view404';
        }
        // Load page import on demand.
        var resolvedPageUrl = this.resolveUrl('books-' + validPage + '.html');
        this.importHref(resolvedPageUrl, null, null, true);
      },

      _showPage404: function() {
        this.page = 'view404';
      },
      searchByText: function(text) {
        var search = this.$.search;
        if(text!=='' && text ) {
          this._resetRequestData();
          this.set('isSearchAuto', true);
        }
      },
      getAll: function(e) {
        if (e.target.value === '') {
          this._resetRequestData();
          this.$.books.generateRequest();
        }
      },
      setCategories: function(categories) {
        if(categories) {
          return categories;  
        }
        return this.categories;
      },
      getUrlCategory: function(category) {
        var cat = ( category || "todas" )
        var subroute = '/books/category/' + cat;
        this._resetRequestData()
        this.set('search.category', cat);
        this.set('search.text', '');
        this.set('url', this.getUrl(this.urlApi, subroute));
      },
      _resetRequestData: function() {
        this.set('isSearchAuto', false);
        this.set('books', []);
        this.set('currentPage', 0);
        delete this.params.page;
        delete this.search.page;
      }
    });
  </script>
</dom-module>